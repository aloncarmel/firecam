
<html>
  <head>
    <title>FireCamera example</title>

    <style>
        body{font-family:Sans-Serif;}
        canvas{position:absolute; left: -9999em;}
        #imageToForm{width:100%;}
        #preview{margin: 20px 0;}

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <script src="https://cdn.firebase.com/js/client/2.2.5/firebase.js"></script>

  </head>
  <body>

        Broadcasting live feed to #<span id="broadcastidspan"></span><br>

        <video id="video"></video>


        <!-- target for the canvas-->
        <div id="canvasHolder"></div>



    <script>

        var video;
        var dataURL;

        //http://coderthoughts.blogspot.co.uk/2013/03/html5-video-fun.html - thanks :)
        function startFireCam() {

            navigator.myGetMedia = (navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia);
            navigator.myGetMedia({ video: true }, connect, error);

            document.getElementById('broadcastidspan').innerHTML = document.broadcastinit;

            setInterval(function() {firebaseBroadcastImage()},1000);

        }

        function connect(stream) {
            video = document.getElementById("video");
            video.src = window.URL ? window.URL.createObjectURL(stream) : stream;
            video.play();
        }

        function error(e) { console.log(e); }


        function getImage() {
            var canvas = document.createElement('canvas');
            canvas.id = 'hiddenCanvas';
            //add canvas to the body element
            document.body.appendChild(canvas);
            //add canvas to #canvasHolder
            document.getElementById('canvasHolder').appendChild(canvas);
            var ctx = canvas.getContext('2d');
            canvas.width = 640;
            canvas.height = 480;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            //save canvas image as data url
            dataURL = canvas.toDataURL();

            return dataURL;
        }

        function firebaseBroadcastImage() {

          var myFirebaseRef = new Firebase("https://firecamera.firebaseio.com/c/"+document.broadcastinit);
          var imagebase = getImage();
          myFirebaseRef.update({base64:imagebase});

        }

        function getUrlParameter(sParam)
        {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++)
            {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam)
                {
                    return sParameterName[1];
                }
            }
        }

        $(document).ready(function(){

          document.broadcastinit = getUrlParameter('c');

          if(!document.broadcastinit) {

            var broadcastinit =  Math.floor((Math.random() * 9999) + 9999);

            window.location = "?c="+broadcastinit;

          } else {

            startFireCam();

          }

        });



    </script>

  </body>
</html>
